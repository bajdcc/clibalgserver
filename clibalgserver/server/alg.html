<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/css/layx.min.css" media="all">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <title>clibalgserver</title>
</head>

<body>
    <div class="layui-container" id="app" style="background-color: white">
        <div class="layui-row">
            <div class="layui-col-sm16">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                    <legend>算法可视化</legend>
                </fieldset>

                <form class="layui-form" action="">
                    <div class="layui-form-item">
                        <label class="layui-form-label">链接</label>
                        <div class="layui-input-block">
                            <a href="/">首页</a>
                            <a href="#" @click="reload">重置缓存</a>
                            <a href="#" @click="test('test_var')">测试变量</a>
                            <a href="#" @click="test('test_1d')">测试一维数组</a>
                            <a href="#" @click="test('test_2d')">测试二维数组</a>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div>
                            <label class="layui-form-label">输入代码</label>
                            <div class="layui-input-inline" style="width:500px;height:500px">
                                <div id="editor" style="width:500px;height:500px"></div>
                            </div>
                        </div>
                        <div>
                            <label class="layui-form-label">输出结果</label>
                            <div class="layui-input-inline" style="width:400px;height:500px">
                                <textarea placeholder="输出结果" readonly class="layui-textarea" v-model="toutput" rows="20"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button type="submit" class="layui-btn" @click="compile" onclick="return false;">发送</button>
                            <button type="reset" class="layui-btn layui-btn-primary" onclick="return false;">重置</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="js/jquery.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/layx.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/vue.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="ace/ace.js" charset="utf-8"></script>
    <script type="text/javascript" src="ace/ext-language_tools.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/eventbus.js" charset="utf-8"></script>
    <script type="text/javascript">
        layui.use('layer');
        $(document).ready(function() {
            function load_text(url) {
                $.get(url, function(d) {
                    editor.setValue(d);
                }).error(function() {
                    editor.setValue("// 加载出现错误");
                });
            }
            var app = new Vue({
                el: '#app',
                data: {
                    toutput: ""
                },
                methods: {
                    compile: function() {
                        layx.load('load', '正在编译中……');
                        var _this = this;
                        $.ajax('/api/visualize', {
                            method: 'POST',
                            contentType: 'application/json;charset=utf-8',
                            data: JSON.stringify({
                                text: editor.getValue()
                            }),
                            success: function(d) {
                                layx.destroy('load');
                                var data = JSON.parse(d);
                                if (data.code == 200) {
                                    var obj = JSON.parse(data.text);
                                    if (obj.code == 200) {
                                        _this.toutput = data.text;
                                        _this.show_alg(obj.data);
                                    } else {
                                        _this.toutput = "发生错误：\n" + obj.error;
                                    }
                                } else
                                    _this.toutput = data.text;
                            }
                        }).error(function(e) {
                            layx.destroy('load');
                            _this.toutput = e.responseText;
                        });
                    },
                    test: function(t) {
                        load_text("example/" + t + ".cpp");
                    },
                    reload: function() {
                        layx.load('reload', '重置缓存……');
                        var _this = this;
                        $.ajax('/api/reload', {
                            method: 'POST',
                            contentType: 'application/json;charset=utf-8',
                            data: JSON.stringify({
                                test: 123
                            }),
                            success: function(d) {
                                layx.destroy('reload');
                                layer.msg("重置缓存成功");
                            }
                        }).error(function(e) {
                            layx.destroy('reload');
                            layer.msg("重置缓存失败");
                        });
                    },
                    show_alg: function(obj) {
                        var len = obj.length;
                        var pro = '<p>当前步骤：{{current+"/"+total}}</p><br>';
                        pro += '<div class="layui-progress layui-progress-big" lay-filter="step-pro" lay-showpercent="true"><div class="layui-progress-bar" lay-percent="0%"></div></div>';
                        pro += '<br><p>当前操作：</p><br><p>{{curop}}</p>';
                        var cnt = '<div style="margin: 15px;" id="step">' + pro + '</div>';
                        var LTOP = layer.open({
                            type: 1,
                            offset: ['50px', '50px'],
                            id: 'step',
                            title: '算法步骤',
                            content: cnt,
                            shadeClose: false,
                            closeBtn: false,
                            fixed: true,
                            resize: false,
                            btn: ['继续', '自动', '重置', '结束'],
                            btnAlign: 'c',
                            scrollbar: false,
                            success: function() {
                                var app = new Vue({
                                    el: '#step',
                                    data: {
                                        total: len,
                                        current: 0,
                                        step: obj,
                                        curop: "无"
                                    },
                                    methods: {
                                        read_next_ins: function() {
                                            if (this.current > 0) {
                                                var cur = this.current - 1;
                                                var ins = this.step[cur];
                                                if (ins.method == "msg") {
                                                    if (!$("#console").length) {
                                                        var ctx = '<div id="console-app" class="layui-form" style="padding:5px;">' +
                                                            '  <table class="layui-table">' +
                                                            '    <colgroup>' +
                                                            '      <col width="50">' +
                                                            '      <col width="250">' +
                                                            '    </colgroup>' +
                                                            '    <thead>' +
                                                            '      <tr>' +
                                                            '        <th>ID</th>' +
                                                            '        <th>信息</th>' +
                                                            '      </tr> ' +
                                                            '    </thead>' +
                                                            '    <tbody>' +
                                                            '      <tr v-for="item in items">' +
                                                            '        <td>{{item.id}}</td>' +
                                                            '        <td>{{item.text}}</td>' +
                                                            '      </tr>' +
                                                            '    </tbody>' +
                                                            '  </table>' +
                                                            '</div>';
                                                        var L = layer.open({
                                                            type: 1,
                                                            offset: ['50px', '400px'],
                                                            id: 'console',
                                                            title: '输出',
                                                            content: ctx,
                                                            shade: false,
                                                            shadeClose: false,
                                                            closeBtn: false,
                                                            fixed: true,
                                                            resize: false,
                                                            scrollbar: false,
                                                            success: function() {
                                                                $("#console-app").parent().css('overflow', 'hidden');
                                                                var app = new Vue({
                                                                    el: '#console-app',
                                                                    data: {
                                                                        items: []
                                                                    },
                                                                    methods: {}
                                                                });
                                                                var console_id = 1;
                                                                eventBus.on("send-text", function(sender, data, obj) {
                                                                    if (app.items.length >= 5) {
                                                                        app.items = app.items.slice(1);
                                                                    }
                                                                    app.items.push({
                                                                        id: console_id,
                                                                        text: data
                                                                    });
                                                                    console_id++;
                                                                });
                                                                eventBus.emit("send-text", window, ins.value);
                                                            },
                                                            end: function() {
                                                                eventBus.off("send-text");
                                                            }
                                                        });
                                                        eventBus.on("close", function(sender, data, obj) {
                                                            layer.close(L);
                                                        });
                                                    } else {
                                                        eventBus.emit("send-text", window, ins.value);
                                                    }
                                                } else if (ins.method == "create") {
                                                    var oname = ins.name;
                                                    var name = 'trace__' + ins.name;
                                                    var value = ins.value;
                                                    if (!$("#" + name).length) {
                                                        if (!ins.loc) {
                                                            var ctx = '<div id="' + name + '-app" class="layui-form" style="padding:5px;">' +
                                                                '{{value}}' +
                                                                '</div>';
                                                            var L = layer.open({
                                                                type: 1,
                                                                offset: ['400px', '50px'],
                                                                id: name,
                                                                title: '变量跟踪：' + oname,
                                                                content: ctx,
                                                                shade: false,
                                                                shadeClose: false,
                                                                closeBtn: false,
                                                                fixed: true,
                                                                resize: false,
                                                                scrollbar: false,
                                                                success: function() {
                                                                    $("#" + name + "-app").parent().css('overflow', 'hidden');
                                                                    var app = new Vue({
                                                                        el: "#" + name + "-app",
                                                                        data: {
                                                                            value: ""
                                                                        },
                                                                        methods: {}
                                                                    });
                                                                    eventBus.on("modify-" + oname, function(sender, data, obj) {
                                                                        app.value = data.value;
                                                                    });
                                                                    eventBus.on("close-" + oname, function(sender, data, obj) {
                                                                        layer.close(L);
                                                                    });
                                                                },
                                                                end: function() {
                                                                    eventBus.off("modify-" + oname);
                                                                    eventBus.off("close-" + oname);
                                                                }
                                                            });
                                                            eventBus.on("close", function(sender, data, obj) {
                                                                layer.close(L);
                                                            });
                                                        } else if (ins.loc.length == 1) {
                                                            var headers = [];
                                                            for (var jj = 0; jj < ins.loc[0]; jj++) {
                                                                headers.push({
                                                                    key: jj,
                                                                    value: ""
                                                                });
                                                            }
                                                            var ctx = '<div id="' + name + '-app" class="layui-form" style="padding:5px;">' +
                                                                '  <table class="layui-table">' +
                                                                '    <colgroup>' +
                                                                '      <col v-for="header in headers">' +
                                                                '    </colgroup>' +
                                                                '    <thead>' +
                                                                '      <tr>' +
                                                                '        <th v-for="header in headers">{{header.key}}</th>' +
                                                                '      </tr> ' +
                                                                '    </thead>' +
                                                                '    <tbody>' +
                                                                '      <tr>' +
                                                                '        <td v-for="header in headers">{{header.value}}</td>' +
                                                                '      </tr>' +
                                                                '    </tbody>' +
                                                                '  </table>' +
                                                                '</div>';
                                                            var L = layer.open({
                                                                type: 1,
                                                                offset: ['400px', '50px'],
                                                                id: name,
                                                                title: '一维数组跟踪：' + oname,
                                                                content: ctx,
                                                                shade: false,
                                                                shadeClose: false,
                                                                closeBtn: false,
                                                                fixed: true,
                                                                resize: false,
                                                                scrollbar: false,
                                                                success: function() {
                                                                    $("#" + name + "-app").parent().css('overflow', 'hidden');
                                                                    var app = new Vue({
                                                                        el: "#" + name + "-app",
                                                                        data: {
                                                                            headers: headers
                                                                        },
                                                                        methods: {}
                                                                    });
                                                                    eventBus.on("modify-" + oname, function(sender, data, obj) {
                                                                        app.$set(app.headers, data.loc[0], {
                                                                            key: data.loc[0],
                                                                            value: data.value
                                                                        });
                                                                    });
                                                                    eventBus.on("close-" + oname, function(sender, data, obj) {
                                                                        layer.close(L);
                                                                    });
                                                                },
                                                                end: function() {
                                                                    eventBus.off("modify-" + oname);
                                                                    eventBus.off("close-" + oname);
                                                                }
                                                            });
                                                            eventBus.on("close", function(sender, data, obj) {
                                                                layer.close(L);
                                                            });
                                                        } else if (ins.loc.length == 2) {

                                                        } else {
                                                            layer.msg("错误：不支持二维以上数组");
                                                        }
                                                    } else {
                                                        layer.msg("错误：重复创建");
                                                    }
                                                } else if (ins.method == "update") {
                                                    if (!ins.loc) {
                                                        eventBus.emit("modify-" + ins.name, window, {
                                                            value: ins.value
                                                        });
                                                    } else if (ins.loc.length == 1) {
                                                        eventBus.emit("modify-" + ins.name, window, {
                                                            value: ins.value,
                                                            loc: ins.loc
                                                        });
                                                    } else if (ins.loc.length == 2) {
                                                        eventBus.emit("modify-" + ins.name, window, {
                                                            value: ins.value,
                                                            loc: ins.loc
                                                        });
                                                    } else {
                                                        layer.msg("错误：不支持二维以上数组");
                                                    }
                                                } else if (ins.method == "destroy") {
                                                    // eventBus.emit("close-" + ins.name, window, {});
                                                } else {}
                                            }
                                            if (this.current < this.total) {
                                                var ins = this.step[this.current];
                                                var tt = "未知类型";
                                                if (ins.type) {
                                                    if (ins.type == "int") tt = "整型";
                                                    else if (ins.type == "char") tt = "字符型";
                                                }
                                                if (ins.method == "msg") {
                                                    this.curop = "输出：" + ins.value;
                                                } else if (ins.method == "create") {
                                                    if (ins.loc && ins.loc.length) {
                                                        this.curop = "创建" + tt + "数组：" + ins.name +
                                                            (ins.loc.map(a => "[" + a + "]").join(""));
                                                    } else {
                                                        this.curop = "创建" + tt + "变量：" + ins.name;
                                                    }
                                                } else if (ins.method == "update") {
                                                    if (ins.loc && ins.loc.length) {
                                                        this.curop = "更新" + tt + "数组：" + ins.name +
                                                            (ins.loc.map(a => "[" + a + "]").join("")) + "，更改为：" + ins.value;
                                                    } else {
                                                        this.curop = "更新" + tt + "变量：" + ins.name + "，更改为：" + ins.value;
                                                    }
                                                } else if (ins.method == "destroy") {
                                                    this.curop = "销毁：" + ins.name;
                                                } else {
                                                    this.curop = "未知指令";
                                                }
                                            } else {
                                                this.curop = "模拟结束";
                                            }
                                        }
                                    }
                                });
                                this.app = app;
                                layui.use('element', function() {
                                    var element = layui.element;
                                    element.progress('step-pro', '0%');
                                    eventBus.on("progress", function(sender, data, obj) {
                                        app.current = data.i;
                                        app.read_next_ins();
                                        element.progress('step-pro', Math.floor(100 * data.i / len) + '%');
                                    });
                                });
                                app.read_next_ins();
                                eventBus.on("close_all", function(sender, data, obj) {
                                    layer.close(LTOP);
                                });
                            },
                            yes: function() {
                                if (this.app.current < this.app.total)
                                    eventBus.emit("progress", this.app, {
                                        i: this.app.current + 1
                                    });
                            },
                            btn2: function() {
                                var id = setInterval(this.yes.bind(this), 400);
                                eventBus.on("close", function(sender, data, obj) {
                                    clearInterval(id);
                                });
                                return false;
                            },
                            btn3: function() {
                                eventBus.emit("close", window, {});
                                eventBus.emit("progress", this.app, {
                                    i: 0
                                });
                                return false;
                            },
                            btn4: function() {},
                            end: function() {
                                eventBus.emit("close", window, {});
                                eventBus.emit("close_all", window, {});
                                eventBus.offAll();
                            }
                        });
                    }
                }
            });
            var editor = ace.edit("editor");
            ace.require("ace/ext/language_tools");
            editor.setTheme("ace/theme/chrome");
            editor.session.setMode("ace/mode/c_cpp");
            editor.setShowPrintMargin(true);
            editor.setFontSize(18);
            editor.setOptions({
                enableBasicAutocompletion: true,
                enableSnippets: true,
                enableLiveAutocompletion: true
            });
            load_text("example/test_var.cpp");
        });
    </script>
</body>

</html>